# Filename: Dockerfile.ppt
# ---- Stage 1: Builder ----
FROM python:3.12-slim-bookworm as builder

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# Install system dependencies (none needed for ppt_flask.py)
RUN apt-get update && apt-get clean && rm -rf /var/lib/apt/lists/*

# Create a non-root user
RUN groupadd -g 1001 appuser && \
    useradd -u 1001 -g appuser -m -s /bin/bash appuser

# Create and own virtual environment
ENV VENV_PATH=/home/appuser/venv
RUN python3 -m venv $VENV_PATH && \
    chown -R appuser:appuser $VENV_PATH

# Activate virtual environment
ENV PATH="$VENV_PATH/bin:$PATH"

WORKDIR /app

# Copy dependency file
COPY --chown=appuser:appuser requirements.txt .

USER appuser

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt


# ---- Stage 2: Final Image ----
FROM python:3.12-slim-bookworm as final

ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

RUN groupadd -g 1001 appuser && \
    useradd -u 1001 -g appuser -m -s /bin/bash appuser

ENV VENV_PATH=/home/appuser/venv
COPY --from=builder --chown=appuser:appuser $VENV_PATH $VENV_PATH

ENV PATH="$VENV_PATH/bin:$PATH"

WORKDIR /app

USER appuser

# --- CHANGE: Copy ppt_flask.py and its specific modules ---
COPY --chown=appuser:appuser ppt_flask.py .
COPY --chown=appuser:appuser modules/pptfinal.py ./modules/
# Ensure __init__.py exists in modules directory to make it a package
RUN touch modules/__init__.py

EXPOSE 10000

# --- CHANGE: Run the ppt_flask:app object with Gunicorn ---
CMD ["gunicorn", "--bind", "0.0.0.0:10000", "ppt_flask:app"]
